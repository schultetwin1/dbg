name: CI

on:
  push:
    branches:
      - master
  schedule:
    - cron: '0 0 * * *'

jobs:
  ci:
    runs-on: ${{ matrix.host }}
    strategy:
      matrix:
        rust:
          - stable
          - beta
          - nightly
        host:
          - 'ubuntu-latest'
          - 'windows-latest'
          - 'macos-latest'

    steps:
      - name: 'Checkout Code'
        uses: actions/checkout@v1

      - name: 'Setup Rust Toolchain'
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: ${{ matrix.rust }}
          override: true
          components: rustfmt, clippy

      - name: 'Build'
        uses: actions-rs/cargo@v1
        with:
          command: build
          args: --release --all-features

      - name: 'Test'
        uses: actions-rs/cargo@v1
        with:
          command: test

      - name: 'Format Check'
        uses: actions-rs/cargo@v1
        with:
          command: fmt
          args: --all -- --check

      # Removing until https://github.com/rust-lang/rust-clippy/issues/4612 is in stable
      # - name: 'Clippy Check'
      #   uses: actions-rs/cargo@v1
      #   with:
      #     command: clippy
      #     args: -- -D warnings

      # Publish the recently built symbols
      - name: 'Publish built symbols'
        run: |
          ./target/release/symbols -c ci.toml upload target/release/
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      - name: Archive production artifacts
        uses: actions/upload-artifact@v2
        with:
          name: symbols
          path: |
            target/release/symbols